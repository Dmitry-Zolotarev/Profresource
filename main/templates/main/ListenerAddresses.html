{% extends 'main/MainMenu.html' %}
{% block title %}–û–û–û "–ü—Ä–æ—Ñ—Ä–µ—Å—É—Ä—Å" - –∞–¥—Ä–µ—Å–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π{% endblock %}
{% block content %}

<h3>–ê–¥—Ä–µ—Å–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π</h3>
<table class="table" id="addresses-table">
    <thead>
        <tr>
            <th>–°–ª—É—à–∞—Ç–µ–ª—å</th>
            <th>–ê–¥—Ä–µ—Å –ø—Ä–æ–ø–∏—Å–∫–∏</th>
            <th>–£–¥–∞–ª–∏—Ç—å</th>
        </tr>
    </thead>
    <tbody>
        {% for –∞–¥—Ä–µ—Å in –∞–¥—Ä–µ—Å–∞ %}
        <tr>
            <td>
                {{ –∞–¥—Ä–µ—Å.–°–ª—É—à–∞—Ç–µ–ª—å.–§–∞–º–∏–ª–∏—è }} {{ –∞–¥—Ä–µ—Å.–°–ª—É—à–∞—Ç–µ–ª—å.–ò–º—è }} {{ –∞–¥—Ä–µ—Å.–°–ª—É—à–∞—Ç–µ–ª—å.–û—Ç—á–µ—Å—Ç–≤–æ|default_if_none:"" }}
                (–ò–ù–ù: {{ –∞–¥—Ä–µ—Å.–°–ª—É—à–∞—Ç–µ–ª—å.–ò–ù–ù }})
            </td>
            <td>{{ –∞–¥—Ä–µ—Å.–ê–¥—Ä–µ—Å.full_address }}</td>
            <td>
                    <form action="{% url 'delete_listener_address' –∞–¥—Ä–µ—Å.id %}" method="post">
                        {% csrf_token %}
                        <button type="submit" class="delete-button" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?');">X</button>
                    </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<h3>–î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å</h3>
<form method="post" action="{% url 'listener_addresses' %}">
    {% csrf_token %}
    <label>–°–ª—É—à–∞—Ç–µ–ª—å:</label><br>
    <select name="–°–ª—É—à–∞—Ç–µ–ª—å" required>
        {% for —Å–ª—É—à–∞—Ç–µ–ª—å in —Å–ª—É—à–∞—Ç–µ–ª–∏ %}
        <option value="{{ —Å–ª—É—à–∞—Ç–µ–ª—å.id }}">
            {{ —Å–ª—É—à–∞—Ç–µ–ª—å.–§–∞–º–∏–ª–∏—è }} {{ —Å–ª—É—à–∞—Ç–µ–ª—å.–ò–º—è }} {{ —Å–ª—É—à–∞—Ç–µ–ª—å.–û—Ç—á–µ—Å—Ç–≤–æ|default_if_none:"" }} (–ò–ù–ù: {{ —Å–ª—É—à–∞—Ç–µ–ª—å.–ò–ù–ù }})
        </option>
        {% endfor %}
    </select><br>

    <label>–°—Ç—Ä–∞–Ω–∞:</label><br>
    <select name="–°—Ç—Ä–∞–Ω–∞" id="country-select" required>
        {% for —Å—Ç—Ä–∞–Ω–∞ in —Å—Ç—Ä–∞–Ω—ã %}
        <option value="{{ —Å—Ç—Ä–∞–Ω–∞.id }}">{{ —Å—Ç—Ä–∞–Ω–∞.–ù–∞–∑–≤–∞–Ω–∏–µ }}</option>
        {% endfor %}
    </select><br>

    <label>–†–µ–≥–∏–æ–Ω:</label><br>
    <select name="–†–µ–≥–∏–æ–Ω" id="region-select" required></select><br>

    <label>–†–∞–π–æ–Ω:</label><br>
    <select name="–†–∞–π–æ–Ω" id="district-select"></select><br>

    <label>–ù–∞—Å–µ–ª—ë–Ω–Ω—ã–π –ø—É–Ω–∫—Ç:</label><br>
    <select name="–ù–∞—Å–µ–ª–µ–Ω–Ω—ã–π_–ø—É–Ω–∫—Ç" id="place-select" required></select><br>

    <label>–ü–æ—á—Ç–æ–≤—ã–π –∏–Ω–¥–µ–∫—Å:</label><br>
    <select name="–ü–æ—á—Ç–æ–≤—ã–π_–∏–Ω–¥–µ–∫—Å" id="postcode-select" required>

    </select><br>

    <label>–£–ª–∏—Ü–∞:</label><br>
    <select name="–£–ª–∏—Ü–∞" id="street-select" required></select><br>

    <label>–î–æ–º –∏ –∫–≤–∞—Ä—Ç–∏—Ä–∞:</label><br>
    <input type="text" name="–ù–æ–º–µ—Ä_–¥–æ–º–∞" required><br><br>

    <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å</button>
</form>

<script>
    document.addEventListener('DOMContentLoaded', () => {
    const countrySelect = document.getElementById('country-select');
    const regionSelect = document.getElementById('region-select');
    const districtSelect = document.getElementById('district-select');
    const placeSelect = document.getElementById('place-select');
    const postcodeSelect = document.getElementById('postcode-select');
    const streetSelect = document.getElementById('street-select');

    function clearSelect(select) {
        select.innerHTML = '';
    }

    function populateSelect(select, data, labelKey = '–ù–∞–∑–≤–∞–Ω–∏–µ') {
        clearSelect(select);
        const option = document.createElement('option');
        option.textContent = ''
        select.appendChild(option);
        data.forEach(obj => {
            const option = document.createElement('option');
            option.value = obj.id;
            option.textContent = obj[labelKey] || obj.name;
            select.appendChild(option);
        });
    }

    function loadOptions(url, paramName, paramValue, targetSelect, labelKey = '–ù–∞–∑–≤–∞–Ω–∏–µ') {
        fetch(`${url}?${paramName}=${paramValue}`)
            .then(res => res.json())
            .then(data => populateSelect(targetSelect, data, labelKey));
    }

    // üîΩ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    if (countrySelect.value) {
        loadOptions("/ajax/regions/", '–°—Ç—Ä–∞–Ω–∞', countrySelect.value, regionSelect);
    }

    countrySelect.addEventListener('change', function () {
        loadOptions("/ajax/regions/", '–°—Ç—Ä–∞–Ω–∞', this.value, regionSelect);
        clearSelect(districtSelect);
        clearSelect(placeSelect);
        clearSelect(postcodeSelect);
        clearSelect(streetSelect);
    });

    regionSelect.addEventListener('change', function () {
        const regionId = this.value;
        loadOptions("/ajax/districts/", 'region_id', regionId, districtSelect);
        loadOptions("/ajax/places/", 'region_id', regionId, placeSelect);
        clearSelect(postcodeSelect);
        clearSelect(streetSelect);
    });

    districtSelect.addEventListener('change', function () {
        loadOptions("/ajax/places/", 'district_id', this.value, placeSelect);
        clearSelect(postcodeSelect);
        clearSelect(streetSelect);
    });

    placeSelect.addEventListener('change', function () {
        const placeId = this.value;
        loadOptions("/ajax/postcodes/", 'place_id', placeId, postcodeSelect, '–ò–Ω–¥–µ–∫—Å');
        loadOptions("/ajax/streets/", 'place_id', placeId, streetSelect);
    });
});

</script>

{% endblock %}
